32+32-30
b = solve(xpx) %*% xpy
b
# 3rd fixed effect =
-b[2]-b[3]
# option 1:
x = matrix(c(1,1,0,0,0,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
x
x
xpx = t(x) %*% x
xpx
solve(xpx)
xpy = t(x) %*% y
xpy
b = solve(xpx) %*% xpy
b
# option 1:
# is only useful if you have only one fixed effect
x = matrix(c(1,1,0,0,0,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
x
xpx = t(x) %*% x
xpx
solve(xpx)
xpy = t(x) %*% y
xpy
b = solve(xpx) %*% xpy
b
# option 2:
# the easiest one, can omit the equation for the zero one
# the general mean will be in fact representing the estimate of the mean of that year. The other year effects are deviations/differences from the year that was set to zero,
# set last year = 0
x = matrix(c(1,1,1,1,1,
1,1,0,0,0,
0,0,1,1,0), byrow = FALSE, ncol=3)
x
xpx = t(x) %*% x
xpx
solve(xpx)
xpy = t(x) %*% y
xpy
b = solve(xpx) %*% xpy
b
# option 3:
# fixed effect: 1st + 2nd + 3rd = 0
# => 3rd = -1st -2nd
x = matrix(c(1,1,1,1,1,
1,1,0,0,-1,
0,0,1,1,-1), byrow = FALSE, ncol=3)
x
xpx = t(x) %*% x
xpx
solve(xpx)
xpy = t(x) %*% y
xpy
b = solve(xpx) %*% xpy
b
# set first year = 0
x = matrix(c(1,1,1,1,1,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
x
xpx = t(x) %*% x
xpx
solve(xpx)
xpy = t(x) %*% y
xpy
b = solve(xpx) %*% xpy
b
y
mean(y)
### known data: assume fixed effects are different years
y = c(35.4, 25.1, 32.7, 30.1, 33)
# set first year = 0
x = matrix(c(1,1,1,1,1,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
x
xpx = t(x) %*% x
xpx
solve(xpx)
xpy = t(x) %*% y
xpy
b = solve(xpx) %*% xpy
b
# set last year = 0
x = matrix(c(1,1,1,1,1,
1,1,0,0,0,
0,0,1,1,0), byrow = FALSE, ncol=3)
x
xpx = t(x) %*% x
xpx
solve(xpx)
xpy = t(x) %*% y
xpy
b = solve(xpx) %*% xpy
b
# set first year = 0
x = matrix(c(1,1,1,1,1,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
# option 2:
u = b[1]
# option 2:
b[1] # u
# option 2:
## set first year = 0
b[1] # u
## set first year = 0
x = matrix(c(1,1,1,1,1,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
x
xpx = t(x) %*% x
xpx
solve(xpx)
xpy = t(x) %*% y
xpy
b = solve(xpx) %*% xpy
b
# option 2:
## set first year = 0
b[1] # u
# option 1:
paste("u = 0, fixed effects = ", b)
# option 1:
print("u = 0, fixed effects = ", b)
# option 1:
print("u = 0, fixed effects = ")
b
b
# option 2:
## set first year = 0
paste("u = ", b[1],
"fixed effects: 1st = 0; 2nd = ",b[2],"3rd = ",b[3])
# option 2:
## set first year = 0
paste("u = ", b[1],
",fixed effects: 1st = 0; 2nd = ",b[2],";3rd = ",b[3])
# option 2:
## set first year = 0
paste("u = ", b[1],
",\nfixed effects: 1st = 0; 2nd = ",b[2],";3rd = ",b[3])
# option 2:
## set first year = 0
paste("u = ", b[1],
",\\nfixed effects: 1st = 0; 2nd = ",b[2],";3rd = ",b[3])
# option 2:
## set first year = 0
paste("u = ", b[1]\n,
# option 2:
## set first year = 0
paste("u = ", b[1],
",fixed effects: 1st = 0; 2nd = ",b[2],";3rd = ",b[3])
# option 2:
## set first year = 0
paste("u = ", b[1],"\n",
",fixed effects: 1st = 0; 2nd = ",b[2],";3rd = ",b[3])
# option 2:
## set first year = 0
paste("u = ", b[1],
",fixed effects: 1st = 0; 2nd = ",b[2],";3rd = ",b[3])
## set last year = 0
x = matrix(c(1,1,1,1,1,
1,1,0,0,0,
0,0,1,1,0), byrow = FALSE, ncol=3)
x
xpx = t(x) %*% x
xpx
solve(xpx)
xpy = t(x) %*% y
xpy
b = solve(xpx) %*% xpy
b
## set last year = 0
paste("u = ", b[1],
",fixed effects: 1st = ",b[2],";2nd = ",b[3],";3rd = 0")
# option 3:
# fixed effect: 1st + 2nd + 3rd = 0
# => 3rd = -1st -2nd
x = matrix(c(1,1,1,1,1,
1,1,0,0,-1,
0,0,1,1,-1), byrow = FALSE, ncol=3)
x
xpx = t(x) %*% x
xpx
solve(xpx)
xpy = t(x) %*% y
xpy
b = solve(xpx) %*% xpy
b
# option 3:
paste("u = ", b[1],
",fixed effects: 1st = ",b[2],";2nd = ",b[3],";3rd = ",-b[2]-b[3])
if (opt =1){
opt = 1
if (opt =1){
opt = 1
if (opt ==1){
x = matrix(c(1,1,0,0,0,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
} if (opt ==21){
opt = 1
if (opt ==1){
x = matrix(c(1,1,0,0,0,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
} if (opt ==21){
if (opt ==1){
x = matrix(c(1,1,0,0,0,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
} else if (opt ==21){
x = matrix(c(1,1,1,1,1,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
} else if (opt ==22){
x = matrix(c(1,1,1,1,1,
1,1,0,0,0,
0,0,1,1,0), byrow = FALSE, ncol=3)
} else if (opt ==3){
x = matrix(c(1,1,1,1,1,
1,1,0,0,-1,
0,0,1,1,-1), byrow = FALSE, ncol=3)
}
x
xpx = t(x) %*% x
xpx
solve(xpx)
xpy = t(x) %*% y
xpy
b = solve(xpx) %*% xpy
b
if (opt ==1){
print("u = 0, fixed effects = ")
b
} else if (opt ==21){
paste("u = ", b[1],
",fixed effects: 1st = 0; 2nd = ",b[2],";3rd = ",b[3])
} else if (opt ==22){
paste("u = ", b[1],
",fixed effects: 1st = ",b[2],";2nd = ",b[3],";3rd = 0")
} else if (opt ==3){
paste("u = ", b[1],
",fixed effects: 1st = ",b[2],";2nd = ",b[3],";3rd = ",-b[2]-b[3])
}
if (opt ==1){
print("u = 0, fixed effects: ")
b
} else if (opt ==21){
paste("u = ", b[1],
",fixed effects: 1st = 0; 2nd = ",b[2],";3rd = ",b[3])
} else if (opt ==22){
paste("u = ", b[1],
",fixed effects: 1st = ",b[2],";2nd = ",b[3],";3rd = 0")
} else if (opt ==3){
paste("u = ", b[1],
",fixed effects: 1st = ",b[2],";2nd = ",b[3],";3rd = ",-b[2]-b[3])
}
paste("opt = ",opt,"u = 0, fixed effects: ")
opt = 3
if (opt ==1){
x = matrix(c(1,1,0,0,0,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
} else if (opt ==21){
x = matrix(c(1,1,1,1,1,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
} else if (opt ==22){
x = matrix(c(1,1,1,1,1,
1,1,0,0,0,
0,0,1,1,0), byrow = FALSE, ncol=3)
} else if (opt ==3){
x = matrix(c(1,1,1,1,1,
1,1,0,0,-1,
0,0,1,1,-1), byrow = FALSE, ncol=3)
}
x
xpx = t(x) %*% x
xpx
solve(xpx)
xpy = t(x) %*% y
xpy
b = solve(xpx) %*% xpy
b
if (opt ==1){
paste("opt =",opt,";u = 0, fixed effects: ")
b
} else if (opt ==21){
paste("opt =",opt,"u =", b[1],
",fixed effects: 1st = 0; 2nd =",b[2],";3rd =",b[3])
} else if (opt ==22){
paste("opt =",opt,"u =", b[1],
",fixed effects: 1st =",b[2],";2nd =",b[3],";3rd = 0")
} else if (opt ==3){
paste("opt =",opt,"u =", b[1],
",fixed effects: 1st =",b[2],";2nd =",b[3],";3rd = ",-b[2]-b[3])
}
mean(93,90,85)
mean(c(93,90,85))
mean(c(78,75,85))
y = c(93,90,85,85,75,78)
x = matrix(c(1,1,1,1,1,1,
1,1,1,0,0,0), byrow = FALSE, ncol=2)
x
opt=2
opt=22
if (opt ==1){
x = matrix(c(1,1,0,0,0,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
} else if (opt ==21){
x = matrix(c(1,1,1,1,1,
0,0,1,1,0,
0,0,0,0,1), byrow = FALSE, ncol=3)
} else if (opt ==22){
x = matrix(c(1,1,1,1,1,
1,1,0,0,0,
0,0,1,1,0), byrow = FALSE, ncol=3)
} else if (opt ==3){
x = matrix(c(1,1,1,1,1,
1,1,0,0,-1,
0,0,1,1,-1), byrow = FALSE, ncol=3)
}
x
xpx = t(x) %*% x
xpx # num
solve(xpx)
xpy = t(x) %*% y
if (opt ==1){
paste("opt =",opt,";u = 0, fixed effects: ")
b
} else if (opt ==21){
paste("opt =",opt,";u =", b[1],
",fixed effects: 1st = 0; 2nd =",b[2],";3rd =",b[3])
} else if (opt ==22){
paste("opt =",opt,";u =", b[1],
",fixed effects: 1st =",b[2],";2nd =",b[3],";3rd = 0")
} else if (opt ==3){
paste("opt =",opt,";u =", b[1],
",fixed effects: 1st =",b[2],";2nd =",b[3],";3rd = ",-b[2]-b[3])
}
xpx = t(x) %*% x
xpx # num
solve(xpx)
xpy = t(x) %*% y
y
t(x)
y = matrix(y)
y
xpy = t(x) %*% y
t(x)
y
x
x = matrix(c(1,1,1,1,1,1,
+              1,1,1,0,0,0), byrow = FALSE, ncol=2)
x
xpx = t(x) %*% x
xpx # num
solve(xpx)
xpy = t(x) %*% y
xpy # sum
b = solve(xpx) %*% xpy # sum/num = average
b
q()
# Load required libraries
library(MASS)   # For matrix calculations
library(Matrix) # For efficient matrix operations
y <- c(10, 20, 30)
z <- c(0, 1, 2)  # SNP genotypes (0/1/2 encoding)
n <- length(y)
gamma <- 1e8     # Large value for SNP effect prior variance
sigma_e2 <- 1    # Residual variance (fixed for simplicity)
# ----------------------------
# 2. Compute P(D|M) for the SNP
# ----------------------------
# Construct covariance matrix V = gamma * zz' + I
V <- gamma * outer(z, z) + diag(n)
# Compute V inverse and quadratic form y'V^{-1}y
V_inv <- solve(V)
y_Vinv_y <- t(y) %*% V_inv %*% y
# Log marginal likelihood (Eq. S.2 from BFMAP)
alpha = n/2
beta = y_Vinv_y/2
log_P_DM <- lgamma(alpha) - (alpha)*log(beta) - (n/2)*log(2*pi) - 0.5*log(det(V))
cat("log P(D|M):", log_P_DM, "\n")  # ≈ -11.45
diag(n)
y_V0inv_y <- sum(y^2)  # Since V0 = I
log_P_DM0 <- lgamma(n/2) - (n/2)*log(y_V0inv_y/2) - (n/2)*log(2*pi) - 0.5*log(det(V0))
# ----------------------------
# 3. Compute Bayes Factor and p-value
# ----------------------------
# Null model (M0): V0 = I
V0 <- diag(n)
y_V0inv_y <- sum(y^2)  # Since V0 = I
log_P_DM0 <- lgamma(n/2) - (n/2)*log(y_V0inv_y/2) - (n/2)*log(2*pi) - 0.5*log(det(V0))
log_BF <- log_P_DM - log_P_DM0
log_BF
BF <- exp(log_BF)
BF
cat("Bayes Factor:", BF, "\n")  # ≈ 4.55
y_V0inv_y
n
log_P_DM
log_P_DM0
BF
# p-value from chi-squared approximation (when gamma → ∞)
Q <- (sum(z*y))^2 / (sum(z^2) * sigma_e2)  # Wald statistic
p_value <- pchisq(Q, df=1, lower.tail=FALSE)
cat("p-value:", p_value, "\n")  # ≈ 0
log_P_DM
log_P_DM0
y_V0inv_y
sum(y^2)
I
diag9n)
diag(n)
I=diag(n)
t(y) %*% I %*% y
beta*2
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(Matrix)
y <- c(10, 20, 30)
z <- c(0, 1, 2)
n <- length(y)
gamma <- 1e8  # SNP effect prior variance
sigma_e2 <- 1 # Residual variance
# Construct V = gamma*zz' + I
V <- gamma * tcrossprod(z) + diag(n)
print("Covariance matrix V:")
print(V)
L <- chol(V)  # V = L'L
print("Cholesky factor L:")
print(L)
y_star <- backsolve(L, forwardsolve(t(L), y))
print("Transformed y*:")
print(y_star)
log_P_DM0 <- sum(dnorm(y_star, mean = 0, sd = sqrt(sigma_e2), log = TRUE)
log_P_DM0 <- sum(dnorm(y_star, mean = 0, sd = sqrt(sigma_e2), log = TRUE)
Z_star <- backsolve(L, forwardsolve(t(L), z))
log_P_DM1 <- sum(dnorm(y_star, mean = Z_star * sum(Z_star * y_star)/sum(Z_star^2),
sd = sqrt(sigma_e2), log = TRUE))
log_P_DM1
log_BF <- log_P_DM1 - log_P_DM0
BF <- exp(log_BF)
log_P_DM0
BF
cat("Bayes Factor:", round(BF, 3), "\n")
cat("log BF:", round(log_BF, 3), "\n")
# p-value approximation
Q <- (sum(z*y))^2 / (sum(z^2)*sigma_e2)
p_value <- pchisq(Q, df=1, lower.tail=FALSE)
cat("p-value:", format.pval(p_value), "\n")
load("K:/LabWei/RegioHuhn_Projekt/RegioHuhn_ChiMeiSun/EggImpute/results_assign_2025-10-23.RData")
assign_res[[1]]
library(EggImpute)
data(meta_demo)
View(meta_demo)
setwd("K:/LabWei/ÖkoGen/Legeleistung/Legeleistungen/Daten_AutoNest_Stall3")
hand_path <- "../Legeleistung_Reinzucht_Handaufzeichnungen_ng.xlsx"
hand <- read_excel(hand_path)
library(readxl)
hand <- read_excel(hand_path)
setDT(hand)
hand
hand[, (time_cols) := lapply(.SD, as_hms), .SDcols = time_cols]
hand[, Date := as.Date(Datum, format = "%Y-%m-%d")]
library(data.table)
setDT(hand)
hand
time_cols <- c("Zeit1_A", "Zeit1_E", "Zeit2_A", "Zeit2_E")
hand[, (time_cols) := lapply(.SD, as_hms), .SDcols = time_cols]
library(hms)
library(lubridate)
time_cols <- c("Zeit1_A", "Zeit1_E", "Zeit2_A", "Zeit2_E")
hand[, (time_cols) := lapply(.SD, as_hms), .SDcols = time_cols]
hand[, Date := as.Date(Datum, format = "%Y-%m-%d")]
hand
View(meta_demo)
dd <- unique(meta_demo$Date)
dd
hand_demo <- hand[Date %in% unique(meta_demo$Date),
.(Date, Zeit2_A, Zeit2_E, Abteil, Nest1, Nest2, Nest3, Nest4)]
hand_demo
meta_demo
setwd("K:/LabWei/RegioHuhn_Projekt/RegioHuhn_ChiMeiSun/EggImpute")
meta_demo[, Date:=as.Date(Date)]
ot_min <-0
meta <- prep_data(meta_demo, ot_min = ot_min)
setwd("K:/LabWei/RegioHuhn_Projekt/RegioHuhn_ChiMeiSun/EggImpute")
# install.packages(c("devtools", "roxygen2"))
library(devtools)
library(roxygen2)
load_all()
# Generate documentation (creates NAMESPACE and man/*.Rd files)
document()
# Install the package
install()
setwd("K:/LabWei/RegioHuhn_Projekt/RegioHuhn_ChiMeiSun/EggImpute")
# install.packages(c("devtools", "roxygen2"))
library(devtools)
library(roxygen2)
load_all()
# Remove from library
remove.packages("EggImpute")
# Also check for leftover files
unlink("C:/R-Cran-4.5.1/library/EggImpute", recursive = TRUE, force = TRUE)
